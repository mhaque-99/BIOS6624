---
title: "Data analysis"
author: "Mahfuza Haque Mahi"
date: "2026-02-18"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyr)
library(readr)
library(tibble)
library(naniar)
library(lme4)
library(ggplot2)
library(ggbeeswarm)
library(ggpubr)
library(table1)
#library(gtsummary) # this is a package to make tables of descriptive stats
library(flextable) # this can help print tables to docx (MS Word)
library(tableone) # this is another fairly easy to use descriptive stats package
library(psych) # used for corr.test
library(knitr) # for writing tables
library(kableExtra) # for writing tables
library(cmdstanr)
library(bayesplot)  # diagnostic plots of the MCMC chains
library(posterior)  # for summarizing posterior draws
library(bayestestR) # for calculating higest density posterior intervals
library(mcmcse)     # for calculating MCMCSE's
library(loo)        # for getting model fit statistics (WAIC and LOO-IC)

analytic_dat <- read.csv(here::here("Project1/DataProcessed", "hivclean.csv"))
```

## table 1
```{r, echo = F, results='asis'}
tab1_dat <- analytic_dat %>%
  filter(years == 0) %>%
  filter(!is.na(hard_drugs_bl))  %>%
  mutate(
    educ_grp = forcats::fct_recode(
      educ_grp,
      "High school or less" = "HighSchool_or_less",
      "Some college"        = "SomeCollege",
      "College+"            = "CollegePlus"
    )
  )

tab1_dat <- tab1_dat %>%
  mutate(
    race_grp = factor(
      race_grp,
      levels = c("White", "Other")
    ),
    educ_grp = factor(
      educ_grp,
      levels = c("High school or less", 
                 "Some college", 
                 "College+")
    )
  )

# variable labels
label(tab1_dat$age_bl)   <- "Age (years)"
label(tab1_dat$BMI_bl)   <- "BMI (kg/m2)"
label(tab1_dat$race_grp) <- "Race"
label(tab1_dat$educ_grp) <- "Education"
label(tab1_dat$SMOKE_bl) <- "Smoking status"
label(tab1_dat$logVLOAD) <- "Viral load (log10 copies/mL)"
label(tab1_dat$LEU3N)    <- "CD4+ T-cell count"
label(tab1_dat$AGG_PHYS) <- "Physical QOL (SF-36, 0-100)"
label(tab1_dat$AGG_MENT) <- "Mental QOL (SF-36, 0-100)"
label(tab1_dat$adh_cat) <- "Adherence at Year 2"

tbl1 <- table1(
  ~ age_bl + BMI_bl + race_grp + educ_grp + SMOKE_bl + logVLOAD + LEU3N + AGG_PHYS + AGG_MENT + adh_cat | hard_drugs_bl,
    data = tab1_dat, 
  caption = "Baseline characteristics  (and selected Year 2 follow-up measures) of participants by baseline hard drug use status."
)


tbl1
```



## Frequentist approach
```{r}
# Create a wide dataset with baseline (Y0) and year 2 (Y2)
dat_wide <- analytic_dat %>%
  filter(years %in% c(0, 2)) %>%
  select(
    newid, years,
    hard_drugs_bl, age_bl, BMI_bl, race_grp, educ_grp, SMOKE_bl,
    adh_y2, adh_cat,
    logVLOAD, LEU3N, AGG_PHYS, AGG_MENT
  ) %>%
  pivot_wider(
    id_cols = c(newid, hard_drugs_bl, age_bl, BMI_bl, race_grp, educ_grp, SMOKE_bl, adh_y2, adh_cat),
    names_from = years,
    values_from = c(logVLOAD, LEU3N, AGG_PHYS, AGG_MENT),
    names_glue = "{.value}_y{years}"
  ) %>%
  filter(!is.na(hard_drugs_bl))
```


## Fit 4 ANCOVA models
```{r}
# Model 1: Viral load (log10) at year 2
## without ADH
m_vload <- lm(
  logVLOAD_y2 ~ hard_drugs_bl + logVLOAD_y0 + age_bl + BMI_bl + race_grp + educ_grp + SMOKE_bl,
  data = dat_wide)
summary(m_vload)

## with adherence
m_vload_adj <- lm(logVLOAD_y2 ~ hard_drugs_bl + adh_cat + logVLOAD_y0 + age_bl + BMI_bl + race_grp + educ_grp + SMOKE_bl, data = dat_wide)

summary(m_vload_adj)

# Model 2: CD4 count (LEU3N) at year 2
## without ADH
  m_cd4 <- lm(
  LEU3N_y2 ~ hard_drugs_bl + LEU3N_y0 + age_bl + BMI_bl + race_grp + educ_grp + SMOKE_bl, 
  data = dat_wide)
summary(m_cd4)

## with ADH
m_cd4_adj <- lm(
  LEU3N_y2 ~ hard_drugs_bl + adh_cat + LEU3N_y0 + age_bl + BMI_bl + race_grp + educ_grp + SMOKE_bl,
  data = dat_wide
)

summary(m_cd4_adj)


# Model 3: Physical QOL (AGG_PHYS) at year 2
## without ADH
  m_phys <- lm(
  AGG_PHYS_y2 ~ hard_drugs_bl + AGG_PHYS_y0 + age_bl + BMI_bl + race_grp + educ_grp + SMOKE_bl,
  data = dat_wide
)
summary(m_phys)

## with ADH
m_phys_adj <- lm(
  AGG_PHYS_y2 ~ hard_drugs_bl + adh_cat + AGG_PHYS_y0 + age_bl + BMI_bl + race_grp + educ_grp + SMOKE_bl,
  data = dat_wide
)

summary(m_phys_adj)

# Model 4: Mental QOL (AGG_MENT) at year 2
## without ADH
m_ment <- lm(
  AGG_MENT_y2 ~ hard_drugs_bl + AGG_MENT_y0 + age_bl + BMI_bl + race_grp + educ_grp + SMOKE_bl,
  data = dat_wide
)
summary(m_ment)

## with ADH
m_ment_adj <- lm(
  AGG_MENT_y2 ~ hard_drugs_bl + adh_cat + AGG_MENT_y0 + age_bl + BMI_bl + race_grp + educ_grp + SMOKE_bl,
  data = dat_wide
)

summary(m_ment_adj)
```

## Bayesian models
```{r}
################################################################
# Write & compile Stan model
################################################################

stan_file <- write_stan_file("data {
  int<lower=0> N;                  // number of observations
  int<lower=0> P;                  // number of predictors including intercept
  matrix[N, P] X;                  // design matrix (first column = intercept)
  vector[N] y;                     // outcome

  vector[P] prior_mean;            // prior means for each beta
  vector<lower=0>[P] prior_sd;     // prior SDs for each beta

  real<lower=0> sigma_prior_sd;    // SD for half-normal prior on sigma
}

parameters {
  vector[P] beta;                  // regression coefficients
  real<lower=0> sigma;             // residual SD
}

model {
  // Vectorized priors for regression coefficients
  beta ~ normal(prior_mean, prior_sd);

  // Half-normal prior for sigma
  sigma ~ normal(0, sigma_prior_sd);

  // Likelihood
  y ~ normal(X * beta, sigma);
  

}

generated quantities {
  // log likelihood for each observation for calculating model fit stats
  vector[N] log_lik;
  for (n in 1:N) {
    log_lik[n] = normal_lpdf(y[n] | X[n] * beta, sigma);}
  }", dir="Code/STAN", basename='linear_regression_half_normal'
)


mod <- cmdstan_model('Code/STAN/linear_regression_half_normal.stan')

```

```{r}
##############################################################################
# Function to fit Bayesian regression - Prepare data to pass to stan
##############################################################################

fit_bayes_model <- function(data, formula) {

  d <- model.frame(formula, data = data, na.action = na.omit)

  X <- model.matrix(formula, data = d)  # design matrix in our linear regression
  y <- model.response(d)

# These are variables needed in Stan
# N is the number of observations in the data set 
# P is the number of columns in the design matrix
  N <- nrow(X)
  P <- ncol(X)

# Hyperparameters for prior distributions. These change depending on your assumptions
# For this problem the prior for model error SD (sigma) is a half normal and priors for
# the coefficients are normal with a mean and SD, which can be written flexibly 
# with a mean vector (prior_mean below) and a SD vector (prior_sd below).  

  prior_mean <- rep(0, P)
  prior_sd   <- rep(100, P) # N(0, 100^2)
  sigma_prior_sd <- 100 # Half-Normal(0, 100)

# create data list to pass to STAN
  standata <- list(
    N = N,
    P = P,
    X = X,
    y = y,
    prior_mean = prior_mean,
    prior_sd = prior_sd,
    sigma_prior_sd = sigma_prior_sd
  )

# Fit model
  fit <- mod$sample(
    data = standata,
    chains = 4,
    parallel_chains = 4,
    iter_warmup = 1000,
    iter_sampling = 2000,
    seed = 6624,
    refresh = 200
  )

  list(
    fit = fit,
    coef_names = colnames(X)
  )
}

##############################################################################
# Fit the four Bayesian models - without ADH
##############################################################################

fit_vload <- fit_bayes_model(
  dat_wide,
  logVLOAD_y2 ~ hard_drugs_bl + logVLOAD_y0 +
    age_bl + BMI_bl + race_grp + educ_grp + SMOKE_bl
)

fit_cd4 <- fit_bayes_model(
  dat_wide,
  LEU3N_y2 ~ hard_drugs_bl + LEU3N_y0 +
    age_bl + BMI_bl + race_grp + educ_grp + SMOKE_bl
)

fit_phys <- fit_bayes_model(
  dat_wide,
  AGG_PHYS_y2 ~ hard_drugs_bl + AGG_PHYS_y0 +
    age_bl + BMI_bl + race_grp + educ_grp + SMOKE_bl
)

fit_ment <- fit_bayes_model(
  dat_wide,
  AGG_MENT_y2 ~ hard_drugs_bl + AGG_MENT_y0 +
    age_bl + BMI_bl + race_grp + educ_grp + SMOKE_bl
)

##############################################################################
# Fit the four Bayesian models - with ADH
##############################################################################

fit_vload_adh <- fit_bayes_model(
  dat_wide,
  logVLOAD_y2 ~ hard_drugs_bl + adh_cat + logVLOAD_y0 +
    age_bl + BMI_bl + race_grp + educ_grp + SMOKE_bl
)

fit_cd4_adh <- fit_bayes_model(
  dat_wide,
  LEU3N_y2 ~ hard_drugs_bl + adh_cat + LEU3N_y0 +
    age_bl + BMI_bl + race_grp + educ_grp + SMOKE_bl
)

fit_phys_adh <- fit_bayes_model(
  dat_wide,
  AGG_PHYS_y2 ~ hard_drugs_bl + adh_cat + AGG_PHYS_y0 +
    age_bl + BMI_bl + race_grp + educ_grp + SMOKE_bl
)

fit_ment_adh <- fit_bayes_model(
  dat_wide,
  AGG_MENT_y2 ~ hard_drugs_bl + adh_cat + AGG_MENT_y0 +
    age_bl + BMI_bl + race_grp + educ_grp + SMOKE_bl
)

##############################################################################
# Posterior summary function
##############################################################################

summarize_term <- function(fit_obj, outcome_name, term) {

  idx <- which(fit_obj$coef_names == term)

  draws_mat <- fit_obj$fit$draws(
    variables = paste0("beta[", idx, "]"),
    format = "matrix"
  )

  v <- as.numeric(draws_mat)

  tibble(
    outcome = outcome_name,
    term = term,   # <<< ADD THIS
    mean = mean(v),
    sd = sd(v),
    q2.5 = quantile(v, 0.025),
    q50  = quantile(v, 0.50),
    q97.5 = quantile(v, 0.975),
    pr_lt_0 = mean(v < 0)
  )
}

##############################################################################
# Extract posterior effects for hard drug use 
##############################################################################

# term names to use
term_hd  <- "hard_drugs_blYes"


term_adh <- "adh_cat>=95%"

results_bayes_compare <- bind_rows(
  summarize_term(fit_vload,     "Viral Load (log10)", term_hd) %>% mutate(model = "No adherence"),
  summarize_term(fit_vload_adh, "Viral Load (log10)", term_hd) %>% mutate(model = "With adherence"),
  summarize_term(fit_vload_adh, "Viral Load (log10)", term_adh) %>% mutate(model = "With adherence"),

  summarize_term(fit_cd4,     "CD4 Count", term_hd) %>% mutate(model = "No adherence"),
  summarize_term(fit_cd4_adh, "CD4 Count", term_hd) %>% mutate(model = "With adherence"),
  summarize_term(fit_cd4_adh, "CD4 Count", term_adh) %>% mutate(model = "With adherence"),

  summarize_term(fit_phys,     "Physical QOL", term_hd) %>% mutate(model = "No adherence"),
  summarize_term(fit_phys_adh, "Physical QOL", term_hd) %>% mutate(model = "With adherence"),
  summarize_term(fit_phys_adh, "Physical QOL", term_adh) %>% mutate(model = "With adherence"),

  summarize_term(fit_ment,     "Mental QOL", term_hd) %>% mutate(model = "No adherence"),
  summarize_term(fit_ment_adh, "Mental QOL", term_hd) %>% mutate(model = "With adherence"),
  summarize_term(fit_ment_adh, "Mental QOL", term_adh) %>% mutate(model = "With adherence")
)


results_bayes_compare <- results_bayes_compare %>%
  mutate(
    term = case_when(
      term == "hard_drugs_blYes" ~ "Hard drug use (Yes vs No)",
      term == "adh_cat<95%" ~ "Adherence <95% (vs â‰¥95%)",
      TRUE ~ term
    )
  )

results_bayes_compare
```


### Convergence diagnostics for both model sets
```{r}
########## Convergence Diagnostics ############
model_diagnostics <- function(fit_obj, outcome_name, model_label) {

  summ <- fit_obj$fit$summary()

  tibble(
    outcome = outcome_name,
    model   = model_label,
    max_rhat = max(summ$rhat, na.rm = TRUE),
    min_bulk_ess = min(summ$ess_bulk, na.rm = TRUE),
    min_tail_ess = min(summ$ess_tail, na.rm = TRUE)
  )
}

diag_conv <- bind_rows(
  # --- No adherence ---
  model_diagnostics(fit_vload, "Viral Load (log10)", "No adherence"),
  model_diagnostics(fit_cd4,   "CD4 Count",          "No adherence"),
  model_diagnostics(fit_phys,  "Physical QOL",       "No adherence"),
  model_diagnostics(fit_ment,  "Mental QOL",         "No adherence"),

  # --- With adherence ---
  model_diagnostics(fit_vload_adh, "Viral Load (log10)", "With adherence"),
  model_diagnostics(fit_cd4_adh,   "CD4 Count",          "With adherence"),
  model_diagnostics(fit_phys_adh,  "Physical QOL",       "With adherence"),
  model_diagnostics(fit_ment_adh,  "Mental QOL",         "With adherence")
)

diag_conv
```

### LOO diagnostics for both model sets

```{r}
########## Model Fit Statistics: LOO  ###########
model_fit_stats <- function(fit_obj, outcome_name, model_label) {

  log_lik_matrix <- fit_obj$fit$draws("log_lik", format = "matrix")
  loo_res  <- loo(log_lik_matrix)

  tibble(
    outcome = outcome_name,
    model   = model_label,
    elpd_loo = loo_res$estimates["elpd_loo", "Estimate"],
    looic    = loo_res$estimates["looic", "Estimate"],
    p_loo    = loo_res$estimates["p_loo", "Estimate"]
  )
}

diag_fit <- bind_rows(
  # --- No adherence ---
  model_fit_stats(fit_vload, "Viral Load (log10)", "No adherence"),
  model_fit_stats(fit_cd4,   "CD4 Count",          "No adherence"),
  model_fit_stats(fit_phys,  "Physical QOL",       "No adherence"),
  model_fit_stats(fit_ment,  "Mental QOL",         "No adherence"),

  # --- With adherence ---
  model_fit_stats(fit_vload_adh, "Viral Load (log10)", "With adherence"),
  model_fit_stats(fit_cd4_adh,   "CD4 Count",          "With adherence"),
  model_fit_stats(fit_phys_adh,  "Physical QOL",       "With adherence"),
  model_fit_stats(fit_ment_adh,  "Mental QOL",         "With adherence")
)

diag_fit
```

## MCMC Diagnostics
```{r}
## Helper to find indices automatically
get_beta_idx <- function(fit_obj, term) {
  idx <- which(fit_obj$coef_names == term)
  if (length(idx) == 0) stop("Term not found: ", term,
                             "\nAvailable terms: ", paste(fit_obj$coef_names, collapse = ", "))
  idx
}

# function to make plots for any outcome/model pair
plot_mcmc_diag <- function(fit_no, fit_adh, outcome_label,
                           term_hd = "hard_drugs_blYes",
                           term_adh = "adh_cat>=95%") {

  # indices
  idx_hd_no  <- get_beta_idx(fit_no,  term_hd)
  idx_hd_adh <- get_beta_idx(fit_adh, term_hd)
  idx_adh    <- get_beta_idx(fit_adh, term_adh)

  pars_no  <- c(paste0("beta[", idx_hd_no, "]"), "sigma")
  pars_adh <- c(paste0("beta[", idx_hd_adh, "]"),
                paste0("beta[", idx_adh, "]"),
                "sigma")

  draws_no  <- as_draws_array(fit_no$fit$draws())
  draws_adh <- as_draws_array(fit_adh$fit$draws())

  cat("\n=============================\n")
  cat("Outcome:", outcome_label, "\n")
  cat("=============================\n")

  # --- No adherence ---
  cat("\n--- No adherence model ---\n")
  print(mcmc_trace(draws_no,  pars = pars_no))
  print(mcmc_dens_overlay(draws_no, pars = pars_no))

  # --- With adherence ---
  cat("\n--- With adherence model ---\n")
  print(mcmc_trace(draws_adh,  pars = pars_adh))
  print(mcmc_dens_overlay(draws_adh, pars = pars_adh))
  print(mcmc_acf(draws_adh, pars = pars_adh))
}

# Run for all outcomes
plot_mcmc_diag(fit_vload, fit_vload_adh, "VLOAD")
plot_mcmc_diag(fit_cd4,  fit_cd4_adh,  "CD4 Count")
plot_mcmc_diag(fit_phys, fit_phys_adh, "Physical QOL")
plot_mcmc_diag(fit_ment, fit_ment_adh, "Mental QOL")

```

