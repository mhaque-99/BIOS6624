---
output:
  bookdown::pdf_document2:
    toc: false
    number_sections: false
documentclass: article
geometry: margin=1in
fontsize: 12pt
linestretch: 2
fig.cap: true
header-includes:
  - \usepackage{float}
  - \usepackage{caption}
  - \captionsetup[table]{justification=raggedright,singlelinecheck=false}

latex_engine: xelatex

---

**Data Analysis Plan**
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyr)
library(readr)
library(tibble)
library(naniar)
library(lme4)
library(ggplot2)
library(ggbeeswarm)
library(ggpubr)
library(table1)
#library(gtsummary) # this is a package to make tables of descriptive stats
library(flextable) # this can help print tables to docx (MS Word)
library(tableone) # this is another fairly easy to use descriptive stats package
library(psych) # used for corr.test
library(knitr) # for writing tables
library(kableExtra) # for writing tables
library(cmdstanr)
library(bayesplot)  # diagnostic plots of the MCMC chains
library(posterior)  # for summarizing posterior draws
library(bayestestR) # for calculating higest density posterior intervals
library(mcmcse)     # for calculating MCMCSE's
library(loo)        # for getting model fit statistics (WAIC and LOO-IC)

analytic_dat <- read.csv(here::here("Project1/DataProcessed", "hivclean.csv"))
```

**Introduction**

The data for this project come from the Multicenter AIDS Cohort Study (MACS), a longitudinal prospective cohort study of HIV-infected men followed annually after initiation of highly active antiretroviral therapy (HAART). Our study population consists of HIV-positive men enrolled in MACS who initiated HAART and had complete baseline (year 0) and year 2 follow-up data. The primary exposure of interest is baseline hard drug use status (yes/no). We examine four treatment response outcomes measured at baseline and year 2: (1) Viral load (log10-transformed copies/mL), (2) CD4+ T-cell Count (LEU3N), (3) Physical Quality of Life (AGG_PHYS) and (4) Mental Quality of Life (AGG_MENT). The primary hypothesis is that compared to non-drug users, individuals with baseline hard drug use will show worse treatment response at year 2, indicated by higher viral loads, lower CD4+ counts, and lower quality-of-life scores. Potential confounders include age, BMI, race/ethnicity, education, and baseline smoking status.

**Preliminary Methods**

Data Cleaning and Management: Special missing or improbable values were recoded to missing according to the codebook. Viral load was log-transformed to address extreme right skewness. CD4 counts were examined both on the raw and square-root scale. The analytic dataset includes subjects meeting all of the following criteria: (1) complete baseline data; (2) complete follow-up data at year 2; and (3) initiated ART (everART = 1). This selection ensures that we analyze only individuals with confirmed HAART initiation and complete outcome data at both timepoints. The exposure and all baseline covariates were derived from year 0 data. Race and education were collapsed into broader categories to improve model stability.

Statistical Analysis: Baseline characteristics will be summarized overall and stratified by hard drug use status. For each of the four outcomes, an ANCOVA framework will be used: $Y_{2} = \beta_0 + \beta_1(\text{Hard Drug Use}_{baseline}) + \beta_2 Y_{0} + \mathbf{X}\beta + \varepsilon,$ where $Y_2$ = Year 2 outcome, $Y_0$ = Baseline value of the outcome, $X$ = baseline covariates. $\beta_1$ represents the adjusted difference in Year 2 outcome between baseline hard drug users and non-users, and $\varepsilon_i \sim \mathcal{N}(0, \sigma^2)$. This approach improves efficiency and controls for baseline outcome differences. We will also fit the same models using Bayesian methods with Stan. For each outcome, we will specify weakly informative priors on regression coefficients (N(0, sd = 100)) and a half-normal prior on residual standard deviations. Posterior estimates will be obtained via MCMC sampling. Posterior inference will include 95% HPDI and effective sample size diagnostics. Model fit will be evaluated using information criteria for Bayesian models. The key parameters of interest will be compared in terms of point estimates and interval estimates.

**Preliminary Descriptive Analysis - Table 1**

The analytic cohort includes 506 participants at baseline. Of these, 39 (7.7%) reported hard drug use, and 467 (92.3%) did not. Baseline age and viral load were similar between groups. Hard drug users were more likely to be current smokers and to have lower educational attainment. CD4$^+$ T-cell counts and quality-of-life scores were modestly lower among hard drug users. These differences support adjustment for baseline covariates in subsequent regression analyses.

\newpage
```{r, echo = F, results='asis'}
tab1_dat <- analytic_dat %>%
  filter(years == 0) %>%
  filter(!is.na(hard_drugs_bl))  %>%
  mutate(
    educ_grp = forcats::fct_recode(
      educ_grp,
      "High school or less" = "HighSchool_or_less",
      "Some college"        = "SomeCollege",
      "College+"            = "CollegePlus"
    )
  )

# variable labels
label(tab1_dat$age_bl)   <- "Age (years)"
label(tab1_dat$BMI_bl)   <- "BMI (kg/m2)"
label(tab1_dat$race_grp) <- "Race"
label(tab1_dat$educ_grp) <- "Education"
label(tab1_dat$SMOKE_bl) <- "Smoking status"
label(tab1_dat$logVLOAD) <- "Viral load (log10 copies/mL)"
label(tab1_dat$LEU3N)    <- "CD4+ T-cell count"
label(tab1_dat$AGG_PHYS) <- "Physical QOL (SF-36, 0-100)"
label(tab1_dat$AGG_MENT) <- "Mental QOL (SF-36, 0-100)"

tbl1 <- table1(
  ~ age_bl + BMI_bl + race_grp + educ_grp + SMOKE_bl + logVLOAD + LEU3N + AGG_PHYS + AGG_MENT | hard_drugs_bl,
    data = tab1_dat, 
  caption = "Baseline characteristics of participants by baseline hard drug use status."
)

tbl1
```


