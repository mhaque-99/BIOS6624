---
output:
  bookdown::pdf_document2:
    toc: false
    number_sections: false
documentclass: article
geometry: margin=1in
fontsize: 12pt
linestretch: 2
fig.cap: true
header-includes:
  - \usepackage{float}
  - \usepackage{caption}
  - \captionsetup[table]{justification=raggedright,singlelinecheck=false}

latex_engine: xelatex
---

<!-- Title -->
**Feasibility and Timing Accuracy of a Novel Filter Paper–Based Saliva Collection Method for Assessing Diurnal Cortisol and DHEA**

<!-- Name -->
Mahfuza Haque Mahi[^1]

[^1]: Biostatistics PhD Student, Colorado School of Public Health, University of Colorado Anschutz Medical Campus, Aurora, CO


### Introduction

This project evaluates a novel saliva collection device, the Saliva Procurement and Integrated Testing (SPIT) booklet, for measuring diurnal patterns of salivary cortisol and DHEA in free-living conditions. The dataset provided by the investigator includes repeated saliva samples from 31 healthy adults collected over three days, with four scheduled samples per day per participant (at waking, approximately 30 minutes after waking, before lunch, and approximately 10 hours after waking). Sampling times were recorded via participant-recorded clock time in the booklet, electronically recorded clock time from a MEMS monitoring cap, and self-reported wake time from a sleep diary. Cortisol and DHEA concentrations were measured in nmol/L.

The scientific objective of the study is to evaluate whether the SPIT booklet provides accurate sampling times and hormone measurements to characterize diurnal hormone patterns. The study has three analytic aims: (1) assess agreement between booklet and MEMS-recorded sampling times, (2) evaluate adherence to protocol-specified sampling windows, and (3) examine diurnal changes in cortisol and DHEA over time.

These objectives were translated into testable statistical hypotheses. Agreement was assessed by testing whether booklet-recorded minutes are linearly related to MEMS-recorded minutes since waking with an intercept of zero and a slope of one. Protocol adherence was quantified as the proportion of samples collected within predefined $\pm7.5$ and $\pm15$ minute windows around scheduled targets. Diurnal hormone patterns were examined using mixed-effects regression models to assess early post-waking changes and subsequent rates of change.

### Methods

#### Data Management and Cleaning:

Data cleaning followed prespecified quality-control criteria in consultation with the investigator. Sample interval variables were excluded  due to unverifiable accuracy. Time since waking was calculated by combining collection dates with clock times and subtracting sleep diary-reported wake times.

Hormone measurements reported in alternative units were excluded to avoid redundancy.  Cortisol values $>80$ nmol/L were excluded as implausible; DHEA measurements at the detection limit (5.205 nmol/L) were excluded. Participants with $>2$ censored DHEA observations were excluded from diurnal analyses. Missing timing data were retained for descriptive analyses. Derived variables included minutes since waking based on booklet and MEMS times and the difference between the two measures.

#### Preliminary Data Analysis:

Descriptive summaries and graphical displays were used to examine sample availability, missing data patterns, agreement between timing measures, and hormone distributions over time. These exploratory analyses informed model specification but were not used for formal inference.

#### Statistical Analysis

#### Agreement Between Booklet and MEMS Sampling Times:

Agreement was evaluated among samples with non-missing booklet and MEMS times. Scatter plots and Bland–Altman plots were used for graphical assessment. Formal evaluation employed a linear mixed-effects model with booklet-recorded minutes since waking as the outcome, MEMS-recorded minutes since waking as the predictor, and a participant-level random intercept. Agreement was defined by an intercept of zero and a slope of one, assessed using Wald tests and 95% confidence intervals.

#### Protocol Adherence to Scheduled Sampling Times:

Adherence to the +30-minute and +10-hour sampling targets was defined as collection within $\pm7.5$ and $\pm15$ minute windows based on sleep diary-reported wake time. Adherence was assessed separately using booklet and MEMS times. Device agreement was summarized using absolute time differences. Analyses were descriptive, reflecting the feasibility focus of the study.

#### Diurnal Changes in Cortisol and DHEA:

Diurnal hormone patterns were analyzed using log-transformed cortisol and DHEA concentrations in linear mixed-effects models with a participant-level random intercept. Time since waking was modeled using a piecewise linear function with a knot at 30 minutes post-waking. Fixed effects estimated early post-waking change and subsequent rates of change. Results were back-transformed to percent change, with statistical significance assessed at the 0.05 level. Model diagnostics are provided in Appendix A.

#### Statistical Software:

All analyses were conducted using R version 4.3.1 (2023-06-16 ucrt).

### Results 

**Descriptive statistics (Table 1)**

Table 1 summarizes the availability of timing data and the distribution of cortisol and DHEA measurements across scheduled collection time points and overall.Timing data were largely complete, with booklet times available for over 90% of samples and MEMS times for more than 80%. Missingness was slightly higher at the +30-minute collection. Hormone measurements were missing in fewer than 3% of samples. Cortisol and DHEA concentrations were highest near waking and declined over the day.

**Agreement Between Booklet-Recorded and MEMS-Recorded Sampling Times**

Figure 1 shows strong agreement between booklet- and MEMS-recorded sampling times. Scatter plots demonstrated close alignment with the line of identity, with slightly greater dispersion at later time points. Bland–Altman plots indicated minimal overall bias with increasing variability later in the day.

Table 2 presents results from a linear mixed-effects model evaluating the agreement between booklet recorded and MEMS recorded minutes since waking, accounting for repeated measurements within subjects. Mixed-effects regression confirmed near-perfect proportional agreement (slope = 0.99, 95% CI: 0.98-1.01; p < 0.001). The intercept was modestly negative (-6.7 minutes), indicating booklet times were recorded slightly earlier than MEMS times. Overall, agreement between devices was strong with minimal systematic bias.

**Adherence to Scheduled Saliva Collection Times (+30 Minutes and +10 Hours)**

Table 3 summarizes device agreement between booklet and MEMS recorded sampling times and participant adherence to the scheduled +30 minute and +10 hour saliva collection windows. Protocol adherence was higher for the +30-minute sample than for the +10-hour sample. For the +30-minute sample, 78.6% of booklet times and 52.9% of MEMS times fell within $\pm7.5$ minutes (increasing to 90.5% and 70.6% within $\pm15$ minutes). Adherence to the +10-hour collection was lower (33.8% within $\pm7.5$ minutes, 41.2% within $\pm15$ minutes by MEMS), indicating greater difficulty maintaining compliance later in the day. Booklet-based estimates overestimated adherence relative to electronic monitoring.

**Diurnal Changes in Cortisol and DHEA Over Time Since Waking**

Figure 2 illustrates expected diurnal patterns for both hormones. Cortisol increased modestly from waking to 30 minutes post-waking and declined thereafter, while DHEA declined sharply after waking with a slower subsequent decrease.

Table 4 presents the estimated percent changes in cortisol and DHEA levels over time estimated form a piecewise linear mixed-effects models with a knot at 30 minutes after waking. Cortisol increased 25.9% from waking to 30 minutes (95% CI: -2.3% to 62.2%; p = 0.076) then declined 12.3% per hour thereafter (95% CI: -14.1% to -10.4%; p < 0.001). DHEA decreased 46.2% within 30 minutes (95% CI: -56.7% to -33.3%; p < 0.001) and continued declining 9.0% per hour (95% CI: -10.6% to -7.4%; p < 0.001). These patterns match established diurnal profiles and support the validity of the SPIT method.

### Discussion

This analysis evaluated the feasibility of the SPIT booklet by assessing timing agreement, protocol adherence, and diurnal hormone patterns. Booklet-recorded times showed strong proportional agreement with electronically recorded MEMS times, with only a small systematic tendency toward earlier recording. This level of agreement is unlikely to meaningfully affect characterization of diurnal hormone profiles.

Adherence was higher for early post-waking collections than for late-day collections, particularly when assessed using electronic monitoring. Discrepancies between booklet- and MEMS-based adherence highlight the value of electronic monitoring for accurately assessing compliance, especially later in the day.

Despite variability in sampling times, the SPIT booklet captured expected diurnal patterns of cortisol and DHEA consistent with established physiology. These findings support the feasibility of the SPIT method for free-living hormone assessment and suggest it may be useful in large-scale or resource-limited studies, particularly when combined with electronic monitoring.

### Limitations

This analysis has several limitations that should be considered when interpreting the findings. The study was conducted in a small sample of healthy adults, limiting generalizability. Time since waking relied on self-reported wake times, which may introduce error. Missing timing data occurred due to incomplete recording and device malfunction. Analyses were exploratory and unadjusted for multiple comparisons. Hormone measurements were limited to three consecutive days, restricting assessment of longer-term variability. Despite these limitations, the results provide supportive evidence for the feasibility of the SPIT method and identify areas for improvement in future studies.

\newpage

```{r setup, include=FALSE, warning = F, message = F}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(Hmisc)
library(lubridate)
library(table1)
library(tidyr)
library(lme4)
library(ggplot2)
library(lmerTest)
library(knitr)
library(kableExtra)
library(patchwork)
library(broom.mixed)
library(emmeans)
library(flextable)
raw_dat <- read.csv(here::here("Project0/DataRaw", "Project0_Clean_v2.csv"))

set_flextable_defaults(fonts_ignore = TRUE)
```

```{r, echo = F}
# -----------------------------
# Analytic dataset
# -----------------------------

analysis_dat <- raw_dat %>%
  
  # Remove sample interval variables (deemed unreliable by investigator)
  # and hormone measures in alternative units to avoid redundancy
  select(
    -Booklet..Sample.interval,
    -Booklet..Sample.interval.Decimal.Time..mins.,
    -MEMs..Sample.interval,
    -MEMs..Sample.interval.Decimal.Time..mins.,
    -Cortisol..ug.dl.,
    -DHEA..pg.dl.
  ) %>%
  
  # Identify participants with repeated DHEA values at the assay
  # upper detection limit (5.205 nmol/L)
  group_by(SubjectID) %>%
  mutate(
    dhea_upper_hits = sum(DHEA..nmol.L. == 5.205, na.rm = TRUE)
  ) %>%
  ungroup()

# Identify participants to exclude:
# participants with more than two DHEA values at the detection limit
removed_info <- analysis_dat %>%
  filter(dhea_upper_hits > 2) %>%
  distinct(SubjectID, dhea_upper_hits)

participants_to_remove <- removed_info$SubjectID

# Apply participant-level exclusions and hormone quality-control rules
analysis_dat <- analysis_dat %>%
  
  # Exclude flagged participants entirely
  filter(!SubjectID %in% participants_to_remove) %>%
  
  # Apply biologically motivated hormone exclusions:
  #   - Cortisol > 80 nmol/L treated as implausible (set to missing)
  #   - DHEA at detection limit removed to avoid flattening diurnal patterns
  mutate(
    Cortisol..nmol.L. = ifelse(Cortisol..nmol.L. > 80, NA, Cortisol..nmol.L.),
    DHEA..nmol.L.     = ifelse(DHEA..nmol.L. == 5.205, NA, DHEA..nmol.L.)
  ) %>%
  
  # Remove temporary detection-limit counter
  select(-dhea_upper_hits) %>%
  
  # Clean clock-time variables:
  # trim whitespace and convert empty strings to missing values
  mutate(
    Booket..Clock.Time = na_if(trimws(Booket..Clock.Time), ""),
    MEMs..Clock.Time   = na_if(trimws(MEMs..Clock.Time), ""),
    Sleep.Diary.reported.wake.time = na_if(trimws(Sleep.Diary.reported.wake.time), "")
  ) %>%
  
  # Convert clock-time variables into POSIXct datetimes by
  # combining with the collection date
  mutate(
    booklet_time = as.POSIXct(
      paste(Collection.Date, Booket..Clock.Time),
      format = "%m/%d/%Y %H:%M",
      tz = "America/Denver"
    ),
    cap_time = as.POSIXct(
      paste(Collection.Date, MEMs..Clock.Time),
      format = "%m/%d/%Y %H:%M",
      tz = "America/Denver"
    ),
    reported_wake_time = as.POSIXct(
      paste(Collection.Date, Sleep.Diary.reported.wake.time),
      format = "%m/%d/%Y %H:%M",
      tz = "America/Denver"
    )
  ) %>%
  
  # Order observations to ensure correct propagation of wake time
  arrange(SubjectID, Collection.Date, Collection.Sample) %>%
  
  # Carry forward reported wake time within each subject and collection day
  group_by(SubjectID, Collection.Date) %>%
  fill(reported_wake_time, .direction = "down") %>%
  ungroup() %>%
  
  # Compute derived timing variables (in minutes):
  #   - Time since waking using booklet time
  #   - Time since waking using MEMS cap time
  #   - Difference between booklet and MEMS times (agreement metric)
  mutate(
    wake_diff_booklet = as.numeric(
      difftime(booklet_time, reported_wake_time, units = "mins")
    ),
    wake_diff_cap = as.numeric(
      difftime(cap_time, reported_wake_time, units = "mins")
    ),
    diff_booklet_cap = as.numeric(
      difftime(booklet_time, cap_time, units = "mins")
    )
  )
```


```{r, echo = F}
# -----------------------------
# Table 1 (analytic dataset)
# -----------------------------
# --- Make group + indicators readable ---
df_tab <- analysis_dat %>%
  mutate(
    # Grouping variable
    Collection.Sample = factor(
      Collection.Sample,
      levels = 1:4,
      labels = c("Waking", "+30 min", "Lunch", "+10 hours")
    ),


    # Time availability indicators (for missingness reporting)
    booklet_time_avail = ifelse(is.na(Booket..Clock.Time), "No", "Yes"),
    mems_time_avail    = ifelse(is.na(MEMs..Clock.Time), "No", "Yes"),
    wake_time_avail    = ifelse(is.na(Sleep.Diary.reported.wake.time), "No", "Yes"),

  ) %>%
  mutate(
    booklet_time_avail = factor(booklet_time_avail, levels = c("Yes","No")),
    mems_time_avail    = factor(mems_time_avail,    levels = c("Yes","No")),
    wake_time_avail    = factor(wake_time_avail,    levels = c("Yes","No"))
  )

# --- nice labels in the printed table ---
label(df_tab$DAYNUMB) <- "Study day (1–3)"
label(df_tab$booklet_time_avail) <- "Booklet time recorded"
label(df_tab$mems_time_avail) <- "MEMS cap time recorded"
label(df_tab$wake_time_avail) <- "Sleep diary wake time recorded"
label(df_tab$Cortisol..nmol.L.) <- "Cortisol (nmol/L)"
label(df_tab$DHEA..nmol.L.) <- "DHEA (nmol/L)"


# --- Table 1: overall + by sample type ---
table1 <- table1(
  ~ booklet_time_avail + mems_time_avail + wake_time_avail +
    Cortisol..nmol.L. + DHEA..nmol.L.
  | Collection.Sample,
  data = df_tab
)

# Print nicely formatted Table 1
library(dplyr)
library(tidyr)
library(flextable)

# ---------- helper formatters ----------
fmt_med_iqr <- function(x, digits = 2) {
  x <- x[!is.na(x)]
  if (length(x) == 0) return("—")
  q <- quantile(x, probs = c(0.25, 0.5, 0.75), na.rm = TRUE)
  sprintf(paste0("%.", digits, "f [%.", digits, "f, %.", digits, "f]"),
          q[2], q[1], q[3])
}

fmt_n_pct_yes <- function(x) {
  # expects factor with levels c("Yes","No")
  n <- sum(!is.na(x))
  ny <- sum(x == "Yes", na.rm = TRUE)
  if (n == 0) return("—")
  sprintf("%d (%.1f%%)", ny, 100 * ny / n)
}

# ---------- compute summaries by Collection.Sample ----------
tab_long <- df_tab %>%
  mutate(Collection.Sample = as.character(Collection.Sample)) %>%
  group_by(Collection.Sample) %>%
  summarise(
    `Booklet time recorded, N (%)`          = fmt_n_pct_yes(booklet_time_avail),
    `MEMS cap time recorded, N (%)`         = fmt_n_pct_yes(mems_time_avail),
    `Sleep diary wake time recorded, N (%)` = fmt_n_pct_yes(wake_time_avail),
    `Cortisol (nmol/L), Median [IQR]`       = fmt_med_iqr(Cortisol..nmol.L.),
    `DHEA (nmol/L), Median [IQR]`           = fmt_med_iqr(DHEA..nmol.L.),
    .groups = "drop"
  ) %>%
  pivot_longer(
    cols = -Collection.Sample,
    names_to = "Variable",
    values_to = "Value"
  )

# ---------- add Overall column ----------
overall_long <- df_tab %>%
  summarise(
    `Booklet time recorded, N (%)`          = fmt_n_pct_yes(booklet_time_avail),
    `MEMS cap time recorded, N (%)`         = fmt_n_pct_yes(mems_time_avail),
    `Sleep diary wake time recorded, N (%)` = fmt_n_pct_yes(wake_time_avail),
    `Cortisol (nmol/L), Median [IQR]`       = fmt_med_iqr(Cortisol..nmol.L.),
    `DHEA (nmol/L), Median [IQR]`           = fmt_med_iqr(DHEA..nmol.L.),
    Collection.Sample = "Overall",
  ) %>%
  pivot_longer(
    cols = -Collection.Sample,
    names_to = "Variable",
    values_to = "Value"
  )

tab_long2 <- bind_rows(overall_long, tab_long)

# ---------- make wide: rows=Variable, cols=Collection.Sample ----------
tab1_wide <- tab_long2 %>%
  pivot_wider(
    names_from = Collection.Sample,
    values_from = Value
  )

# order rows nicely
row_order <- c(
  "Booklet time recorded, N (%)",
  "MEMS cap time recorded, N (%)",
  "Sleep diary wake time recorded, N (%)",
  "Cortisol (nmol/L), Median [IQR]",
  "DHEA (nmol/L), Median [IQR]"
)


tab1_wide <- tab1_wide %>%
  mutate(Variable = factor(Variable, levels = row_order)) %>%
  arrange(Variable) %>%
  mutate(Variable = as.character(Variable))

tab1_wide <- tab1_wide %>%
  relocate(Overall, .after = last_col())

ft_tbl1 <- flextable(tab1_wide)

ft_tbl1 <- ft_tbl1 %>%
  set_caption("Hormone measurements and timing data availability by collection time point.") %>%
  theme_booktabs() %>%
  fontsize(size = 10, part = "all") %>%
  align(align = "center", part = "all") %>%
  align(j = 1, align = "left", part = "all") %>%
  autofit()

# optional widths (helps in PDF/Word)
ft_tbl1 <- width(ft_tbl1, j = 1, width = 2)
ft_tbl1 <- width(ft_tbl1, j = 2:ncol(tab1_wide), width = 1)

ft_tbl1

```

```{r, echo=FALSE}
# -----------------------------
# Q1 analytic dataset:
# require both booklet & cap time since wake
# -----------------------------
q1_dat <- analysis_dat %>%
  filter(!is.na(wake_diff_booklet), !is.na(wake_diff_cap)) %>%
  mutate(
    Collection.Sample = factor(
      Collection.Sample,
      levels = 1:4,
      labels = c("Waking", "+30 min", "Lunch", "+10 hours")
    )
  )

# -----------------------------
# Plot: booklet vs cap time since wake
# -----------------------------
q1_dat <- q1_dat %>%
  mutate(
    diff_booklet_cap = wake_diff_booklet - wake_diff_cap,
    mean_booklet_cap = (wake_diff_booklet + wake_diff_cap) / 2
  )

# Limits of agreement (overall)
loa <- q1_dat %>%
  summarise(
    md = mean(diff_booklet_cap, na.rm = TRUE),
    sd = sd(diff_booklet_cap, na.rm = TRUE),
    upper = md + 1.96 * sd,
    lower = md - 1.96 * sd
  )

# -----------------------------
# (A) Scatter plot
# -----------------------------
p_scatter <- ggplot(q1_dat, aes(x = wake_diff_cap, y = wake_diff_booklet, color = Collection.Sample)) +
  geom_point(alpha = 0.7, na.rm = TRUE) +
  geom_abline(intercept = 0, slope = 1, linetype = 2) +
  labs(
    title = "Scatter plot",
    x = "MEMS minutes since waking",
    y = "Booklet minutes since waking",
    color = "Collection sample"
  ) +
  theme_minimal()

# -----------------------------
# (B) Bland–Altman plot
# -----------------------------
p_ba <- ggplot(q1_dat, aes(x = mean_booklet_cap, y = diff_booklet_cap, color = Collection.Sample)) +
  geom_point(alpha = 0.7, na.rm = TRUE) +
  geom_hline(yintercept = loa$md) +
  geom_hline(yintercept = loa$upper, linetype = 2) +
  geom_hline(yintercept = loa$lower, linetype = 2) +
  labs(
    title = "Bland–Altman",
    x = "Mean minutes since waking",
    y = "Difference (Booklet − MEMS, min)",
    color = "Collection sample"
  ) +
  theme_minimal() +
  guides(color = "none")  # legend will be collected from the left plot

# -----------------------------
# Side-by-side layout
# -----------------------------
(p_scatter | p_ba) +
  plot_layout(guides = "collect") +
  plot_annotation(
    title = "Figure 1: Agreement between booklet and MEMS-recorded sampling times",
    theme = theme(
      plot.title = element_text(hjust = 0.5, face = "bold"),
      legend.position = "bottom"
    )
  ) 
```


```{r, echo = F}
# -----------------------------
# LMM: agreement model
# Outcome: booklet mins since wake
# Predictor: cap mins since wake
# Random intercept: SubjectID
# Perfect agreement => intercept=0, slope=1
# -----------------------------
rq1_agreement <- lmer(
  wake_diff_booklet ~ wake_diff_cap + (1 | SubjectID),
  data = q1_dat,
  REML = TRUE
)
##----Extract model results--------
rq1_tab <- tidy(
  rq1_agreement,
  effects = "fixed",
  conf.int = TRUE
) %>%
  mutate(
    Term = case_when(
      term == "(Intercept)" ~ "Intercept",
      term == "wake_diff_cap" ~ "MEMS minutes since waking"
    ),
    Estimate = round(estimate, 3),
    `Std. Error` = round(std.error, 3),
    `95% CI (Lower)` = round(conf.low, 3),
    `95% CI (Upper)` = round(conf.high, 3),
    `p-value` = ifelse(p.value < 0.001, "<0.001", round(p.value, 3))
  ) %>%
  select(
    Term,
    Estimate,
    `Std. Error`,
    `95% CI (Lower)`,
    `95% CI (Upper)`,
    `p-value`
  )

##------Create the formatted table-------
ft_q1 <- flextable(rq1_tab)

# Add caption
ft_q1 <- set_caption(
  ft_q1,
  caption = "Linear mixed-effects model assessing agreement between booklet and MEMS sampling times."
)

# Basic formatting
ft_q1 <- ft_q1 %>%
  autofit() %>%
  align(align = "center", part = "all") %>%
  align(j = 1, align = "left", part = "all") %>%   # left-align first column
  theme_booktabs() 

# Add footnote safely (no clipping)
ft_q1 <- add_footer_lines(
  ft_q1,
  values = paste(
    "Note. Outcome: booklet-recorded minutes since waking.",
    "Predictor: MEMS-recorded minutes since waking.",
    "Model includes a random intercept for subject.",
    "N =", nrow(q1_dat), "observations from",
    length(unique(q1_dat$SubjectID)), "subjects."
  )
)

# Make footnote smaller
ft_q1 <- fontsize(ft_q1, size = 8, part = "footer")


# widths (helps in PDF/Word)
ft_q1 <- width(ft_q1, j = 1, width = 1.6)
ft_q1 <- width(ft_q1, j = 2:6, width = 1.1)

ft_q1
```

```{r, echo = F}
# ============================================================
# Q2. Adherence to scheduled sampling times
# Targets:
#   sample 2: 30 min after waking
#   sample 4: 600 min (10 hours) after waking
# Windows:
#   within 7.5 min and within 15 min of target
# Time since wake comes from sleep diary wake time.
# ============================================================

# Overall agreement within windows: booklet vs cap (all samples)
q2_agree_overall <- analysis_dat %>%
  summarise(
    n = sum(!is.na(diff_booklet_cap)),
    n_missing = sum(is.na(diff_booklet_cap)),
    perc_within_7.5 = mean(abs(diff_booklet_cap) <= 7.5, na.rm = TRUE) * 100,
    perc_within_15  = mean(abs(diff_booklet_cap) <= 15,  na.rm = TRUE) * 100
  )

#q2_agree_overall

# Agreement within windows, restricted to +30 and +10h samples
q2_agree_30_10h <- analysis_dat %>%
  filter(Collection.Sample %in% c(2, 4)) %>%
  group_by(Collection.Sample) %>%
  summarise(
    n = sum(!is.na(diff_booklet_cap)),
    n_missing = sum(is.na(diff_booklet_cap)),
    perc_within_7.5 = mean(abs(diff_booklet_cap) <= 7.5, na.rm = TRUE) * 100,
    perc_within_15  = mean(abs(diff_booklet_cap) <= 15,  na.rm = TRUE) * 100,
    .groups = "drop"
  )

#q2_agree_30_10h


# -----------------------------
# DEVICE AGREEMENT: overall + (+30, +10h)
# -----------------------------
agreement_overall <- q2_agree_overall %>%
  mutate(timepoint = "Overall") %>%
  select(timepoint, n, n_missing, perc_within_7.5, perc_within_15) %>%
  rename(
    agree_n       = n,
    agree_missing = n_missing,
    agree_7p5     = perc_within_7.5,
    agree_15      = perc_within_15
  )

agreement_by_tp <- q2_agree_30_10h %>%
  mutate(
    timepoint = case_when(
      Collection.Sample == 2 ~ "+30 min",
      Collection.Sample == 4 ~ "+10 hours"
    )
  ) %>%
  select(timepoint, n, n_missing, perc_within_7.5, perc_within_15) %>%
  rename(
    agree_n       = n,
    agree_missing = n_missing,
    agree_7p5     = perc_within_7.5,
    agree_15      = perc_within_15
  )

agreement_tbl <- bind_rows(agreement_overall, agreement_by_tp)

# -----------------------------
# PROTOCOL ADHERENCE: only for (+30, +10h)
# -----------------------------
adherence_tbl <- analysis_dat %>%
  filter(Collection.Sample %in% c(2, 4)) %>%
  mutate(
    timepoint   = if_else(Collection.Sample == 2, "+30 min", "+10 hours"),
    target_mins = if_else(Collection.Sample == 2, 30, 600),
    dev_booklet = wake_diff_booklet - target_mins,
    dev_cap     = wake_diff_cap     - target_mins
  ) %>%
  summarise(
    booklet_7p5 = mean(abs(dev_booklet) <= 7.5, na.rm = TRUE) * 100,
    booklet_15  = mean(abs(dev_booklet) <= 15,  na.rm = TRUE) * 100,
    cap_7p5     = mean(abs(dev_cap)     <= 7.5, na.rm = TRUE) * 100,
    cap_15      = mean(abs(dev_cap)     <= 15,  na.rm = TRUE) * 100,
    .by = timepoint
  )

# -----------------------------
# MERGE + add NA for Overall adherence
# -----------------------------
combined_tbl <- agreement_tbl %>%
  left_join(adherence_tbl, by = "timepoint") %>%
  mutate(across(where(is.numeric), ~ round(.x, 1))) %>%
  mutate(
    booklet_7p5 = if_else(timepoint == "Overall", NA_real_, booklet_7p5),
    booklet_15  = if_else(timepoint == "Overall", NA_real_, booklet_15),
    cap_7p5     = if_else(timepoint == "Overall", NA_real_, cap_7p5),
    cap_15      = if_else(timepoint == "Overall", NA_real_, cap_15)
  ) %>%
  arrange(match(timepoint, c("Overall", "+30 min", "+10 hours")))

# Replace NAs in adherence columns with an em dash for nicer display
combined_tbl_disp <- combined_tbl %>%
  mutate(across(c(booklet_7p5, booklet_15, cap_7p5, cap_15),
                ~ ifelse(is.na(.x), "—", sprintf("%.1f", .x)))) %>%
  mutate(across(c(agree_7p5, agree_15), ~ sprintf("%.1f", .x)))  # keep as 1 decimal

# -----------------------------
# Nicely formatted table
# -----------------------------
ft_tbl3 <- combined_tbl_disp %>%
  select(
    timepoint,
    agree_n, agree_missing, agree_7p5, agree_15,
    booklet_7p5, booklet_15, cap_7p5, cap_15
  ) %>%
  flextable(
    col_keys = c(
      "timepoint",
      "agree_n", "agree_missing", "agree_7p5", "agree_15",
      "booklet_7p5", "booklet_15", "cap_7p5", "cap_15"
    )
  )

# ---- Column labels (bottom header row) ----
ft_tbl3 <- set_header_labels(
  ft_tbl3,
  timepoint      = "Collection time",
  agree_n        = "N",
  agree_missing  = "Missing",
  agree_7p5      = "+/- 7.5 min (%)",
  agree_15       = "+/- 15 min (%)",
  booklet_7p5    = "+/- 7.5 (%)",
  booklet_15     = "+/- 15 (%)",
  cap_7p5        = "+/- 7.5 (%)",
  cap_15         = "+/- 15 (%)"
)


ft_tbl3 <- add_header_row(
  ft_tbl3,
  values = c("", "Device agreement", "Protocol adherence"),
  colwidths = c(1, 4, 4)
)

# ---- Formatting to control width ----
ft_tbl3 <- ft_tbl3 %>%
  theme_booktabs() %>%
  fontsize(size = 9, part = "all") %>%
  align(align = "center", part = "all") %>%
  align(j = 1, align = "left", part = "all") %>%
  autofit()

# tighter widths for PDF
ft_tbl3 <- width(ft_tbl3, j = "timepoint", width = 1.4)
ft_tbl3 <- width(ft_tbl3, j = c("agree_n","agree_missing"), width = 0.65)
ft_tbl3 <- width(ft_tbl3, j = c("agree_7p5","agree_15"), width = 0.85)
ft_tbl3 <- width(ft_tbl3, j = c("booklet_7p5","booklet_15","cap_7p5","cap_15"), width = 0.75)

# force to fit page width (prevents split/repeated caption)
ft_tbl3 <- fit_to_width(ft_tbl3, max_width = 6.5)

# ---- Caption ----
ft_tbl3 <- set_caption(
  ft_tbl3,
  caption = "Device agreement (booklet vs MEMS) and protocol adherence (relative to scheduled target) at scheduled collection times."
)

# ---- Footnote ----
ft_tbl3 <- add_footer_lines(
  ft_tbl3,
  values = paste(
    "Note. Device agreement is defined as the absolute difference between booklet- and MEMS-recorded sampling times.",
    "Protocol adherence is defined as collection within +/- 7.5 or +/- 15 minutes of the scheduled target time",
    "(30 minutes or 600 minutes after waking), using sleep diary-reported wake time as the reference.",
    "Adherence is not defined for the Overall row because it pools multiple scheduled timepoints."
  )
)

ft_tbl3 <- fontsize(ft_tbl3, size = 8, part = "footer")

ft_tbl3
```


```{r, echo = F,  warning = F, message = F}
# ============================================================
# Piecewise linear model with knot at 30 minutes
# ============================================================

# -----------------------------
#  Choose a time-since-wake variable
# Prefer MEMS; fall back to booklet if MEMS missing
# -----------------------------
q3_dat <- analysis_dat %>%
  mutate(
    time_mins = dplyr::coalesce(wake_diff_cap, wake_diff_booklet),

    Collection.Sample = factor(Collection.Sample, levels = 1:4,
                               labels = c("Waking", "+30 min", "Lunch", "+10 hours"))
  ) %>%
  # Keep only reasonable time range for 1-day diurnal curve
  filter(!is.na(time_mins), time_mins >= 0, time_mins <= 900)  # up to 15 hours, adjust if desired

# -----------------------------
# Create piecewise time terms (knot at 30 minutes)
# -----------------------------
q3_dat <- q3_dat %>%
  mutate(
    t1 = pmin(time_mins, 30),         # 0 to 30
    t2 = pmax(time_mins - 30, 0)      # after 30
  )

# -----------------------------
#    log-transform outcomes 
# -----------------------------
q3_dat <- q3_dat %>%
  mutate(
    log_cortisol = if_else(!is.na(Cortisol..nmol.L.) & Cortisol..nmol.L. > 0,
                           log(Cortisol..nmol.L.), NA_real_),
    log_dhea     = if_else(!is.na(DHEA..nmol.L.) & DHEA..nmol.L. > 0,
                           log(DHEA..nmol.L.), NA_real_)
  )

# -----------------------------
# Fit mixed models
# Random intercept for SubjectID
# -----------------------------
m_cort <- lmer(log_cortisol ~ t1 + t2 + (1 | SubjectID), data = q3_dat, REML = TRUE)
m_dhea <- lmer(log_dhea     ~ t1 + t2 + (1 | SubjectID), data = q3_dat, REML = TRUE)

# -----------------------------
# Plot: observed + model-predicted mean curve (on original scale)
# -----------------------------
pred_grid <- data.frame(time_mins = seq(0, 720, by = 5)) %>%  # 0 to 12 hours
  mutate(
    t1 = pmin(time_mins, 30),
    t2 = pmax(time_mins - 30, 0)
  )

pred_grid$cort_pred <- exp(predict(m_cort, newdata = pred_grid, re.form = NA))
pred_grid$dhea_pred <- exp(predict(m_dhea, newdata = pred_grid, re.form = NA))

# Cortisol plot
p_cort <- ggplot(q3_dat, aes(x = time_mins, y = Cortisol..nmol.L.)) +
  geom_point(alpha = 0.35, na.rm = TRUE) +
  geom_line(data = pred_grid, aes(x = time_mins, y = cort_pred),  color = "blue", linewidth = 1, na.rm = TRUE) +
  geom_vline(xintercept = 30, linetype = "dashed", color = "red")+
  labs(
    title = "Cortisol",
    x = NULL,
    y = "Cortisol (nmol/L)"
  )

# DHEA 
p_dhea <- ggplot(q3_dat, aes(x = time_mins, y = DHEA..nmol.L.)) +
  geom_point(alpha = 0.35, na.rm = TRUE) +
  geom_line(data = pred_grid, aes(x = time_mins, y = dhea_pred),  color = "blue", linewidth = 1,  na.rm = TRUE) +
  geom_vline(xintercept = 30, linetype = "dashed", color = "red")+
  labs(
    title = "DHEA",
    x = NULL,
    y = "DHEA (nmol/L)"
  )

# Side-by-side layout
(p_cort | p_dhea) +
  plot_annotation(
    title   = "Figure 2: Diurnal patterns of cortisol and DHEA relative to waking",
    caption = "Minutes since waking (MEMS preferred; booklet fallback)",
    theme = theme(
      plot.title   = element_text(hjust = 0.5, size = 14, face = "bold"),
      plot.caption = element_text(hjust = 0.5, size = 11)
    )
  )


```


```{r, echo = F}
# Helper functions
pct_from_log <- function(x) 100 * (exp(x) - 1)

extract_pct_ci <- function(model, hormone) {

  est <- summary(model)$coefficients
  ci  <- confint(model, parm = c("t1", "t2"), method = "Wald")

  tibble(
    Hormone = hormone,
    Interval = c("Waking → 30 min", "After 30 min (per hour)"),

    Estimate_pct = c(
      pct_from_log(est["t1", "Estimate"] * 30),
      pct_from_log(est["t2", "Estimate"] * 60)
    ),

    CI_low_pct = c(
      pct_from_log(ci["t1", 1] * 30),
      pct_from_log(ci["t2", 1] * 60)
    ),

    CI_high_pct = c(
      pct_from_log(ci["t1", 2] * 30),
      pct_from_log(ci["t2", 2] * 60)
    ),

    p_value = c(
      est["t1", "Pr(>|t|)"],
      est["t2", "Pr(>|t|)"]
    )
  )
}

pct_cort <- extract_pct_ci(m_cort, "Cortisol")
pct_dhea <- extract_pct_ci(m_dhea, "DHEA")

pct_table <- bind_rows(pct_cort, pct_dhea) %>%
  mutate(
    Estimate_pct = round(Estimate_pct, 1),
    CI = paste0("(", round(CI_low_pct, 1), ", ", round(CI_high_pct, 1), ")"),
    p_value = ifelse(p_value < 0.001, "<0.001", round(p_value, 3))
  ) %>%
  select(Hormone, Interval, Estimate_pct, CI, p_value)


###------Print nice formatted table-----

ft_tbl4 <- pct_table %>%
  flextable()

# Column labels
ft_tbl4 <- set_header_labels(
  ft_tbl4,
  Hormone        = "Hormone",
  Interval  = "Time interval",
  Estimate_pct = "Percent change (%)",
  CI          = "95% CI",
  p_value     = "p-value"
)

# Caption
ft_tbl4 <- set_caption(
  ft_tbl4,
  caption = "Estimated percent change in cortisol and DHEA over time since waking"
)

# Styling
ft_tbl4 <- ft_tbl4 %>%
  theme_booktabs() %>%
  fontsize(size = 10, part = "all") %>%
  align(align = "center", part = "all") %>%
  align(j = 1:2, align = "left", part = "all") %>%
  autofit()

# Width control (optional but helps prevent wide tables)
ft_tbl4 <- width(ft_tbl4, j = 1, width = 1.1)  # Hormone
ft_tbl4 <- width(ft_tbl4, j = 2, width = 2.0)  # Time interval
ft_tbl4 <- width(ft_tbl4, j = 3:5, width = 1.0)

# Footnote (safe, non-clipped)
ft_tbl4 <- add_footer_lines(
  ft_tbl4,
  values = paste(
    "Note. Percent changes and confidence intervals were obtained by back-transforming",
    "log-scale mixed-effects model estimates.",
    "Post–30 minute estimates represent percent change per hour.",
    "Positive values indicate increases; negative values indicate declines."
  )
)

# Make footer smaller
ft_tbl4 <- fontsize(ft_tbl4, size = 9, part = "footer")

ft_tbl4
```

\newpage
### Appendix A. Model diagnostics for cortisol and DHEA mixed-effects models
```{r, echo = F}
p_raw_cort <- ggplot(analysis_dat, aes(x = Cortisol..nmol.L.)) +
  geom_histogram(bins = 30, fill = "grey70", color = "black",na.rm = TRUE) +
  labs(
    title = "Raw cortisol",
    x = "Cortisol (nmol/L)",
    y = "Count"
  ) +
  theme_minimal()

p_log_cort <- ggplot(analysis_dat, aes(x = log(Cortisol..nmol.L.))) +
  geom_histogram(bins = 30, fill = "grey70", color = "black", na.rm = TRUE) +
  labs(
    title = "Log-transformed cortisol",
    x = "log(Cortisol)",
    y = "Count"
  ) +
  theme_minimal()

p_raw_dhea <- ggplot(analysis_dat, aes(x = DHEA..nmol.L.)) +
  geom_histogram(bins = 30, fill = "grey70", color = "black", na.rm = TRUE) +
  labs(
    title = "Raw DHEA",
    x = "DHEA (nmol/L)",
    y = "Count"
  ) +
  theme_minimal()

p_log_dhea <- ggplot(analysis_dat, aes(x = log(DHEA..nmol.L.))) +
  geom_histogram(bins = 30, fill = "grey70", color = "black",na.rm = TRUE) +
  labs(
    title = "Log-transformed DHEA",
    x = "log(DHEA)",
    y = "Count"
  ) +
  theme_minimal()

## side by side layout
(p_raw_cort | p_log_cort) /
(p_raw_dhea | p_log_dhea) +
  plot_annotation(
    title = "Distributions of raw and log-transformed hormone concentrations",
    theme = theme(
      plot.title = element_text(hjust = 0.5, face = "bold")
    )
  )

```

Raw hormone concentrations exhibit substantial right skewness, which is reduced after log transformation, supporting the use of log-scale outcomes in mixed-effects modeling.

\newpage
### Reproducible Research Information
GitHub Repository: https://github.com/mhaque-99/BIOS6624/tree/main
File name for Code: Project0/Code/Report.rmd
File name for Final report:Project0/Reports/Report.pdf